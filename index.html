<!DOCTYPE html>
<html lang="en">
  <head>
    <link type="text/css" rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <!DOCTYPE html>
<html lang="en">
  <head>
    <link type="text/css" rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Asistencia</title>
  <script type="module" src="https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background:
        linear-gradient(to bottom, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8)),
        url("https://scontent-bog2-1.xx.fbcdn.net/v/t39.30808-6/524650204_122094640142964969_1459088055870371527_n.jpg?_nc_cat=104&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=GrTTwEdfZJ4Q7kNvwHXN6mP&_nc_oc=Adk6dBZfHYHSP3VAkcaVbG8-TRANwrb0XCpJLxejbg4RFA-lSTwv6EBSXDwmiiAEjKQ&_nc_zt=23&_nc_ht=scontent-bog2-1.xx&_nc_gid=kZG-vgqghPcC0Nl9vDA4Tg&oh=00_AfWH54jk3B_3G-3DJrws-95xXLOPKxhRCny6C3T1k_BE2w&oe=68AE627A")
        no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .container, #login-form {
      margin: 60px auto;
      padding: 30px;
      background: #ffffffee;
      width: 90%;
      max-width: 600px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      color: #222;
    }
    h2, h3 {
      color: #000000;
      margin-bottom: 20px;
      font-weight: bold;
    }
    button {
      margin-top: 20px;
      padding: 14px 28px;
      border: none;
      background: #000000;
      color: white;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    button:hover {
      background: #000000;
      transform: scale(1.05);
    }
    input, select {
      width: 95%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .video-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      max-width: 340px;
      height: 240px;
      margin: 25px auto;
      background: black;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background: #FFFFFF;
      color: #333;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    th {
      background: #000000;
      color: white;
    }
    .admin-container {
      display: none;
    }
    #loader {
      font-weight: bold;
      margin-top: 20px;
      color: #000000;
      display: none;
    }
    .flash {
      animation: flash 0.3s ease-in-out;
    }
    @keyframes flash {
      0% { background-color: #000000; }
      100% { background-color: #000; }
    }
    .delete-btn {
      background-color: #000000;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .delete-btn:hover {
      background-color: #000000;
    }
    #message-popup {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background-color: rgba(0, 0, 0, 1);
      color: white;
      border-radius: 8px;
      font-size: 16px;
      display: none;
      z-index: 9999;
    }
    /* Breadcrumb style */
    nav#breadcrumb {
      margin: 15px auto;
      width: 90%;
      max-width: 600px;
      font-size: 14px;
      color: white;
      text-align: left;
      user-select: none;
    }
    nav#breadcrumb span {
      cursor: pointer;
      text-decoration: underline;
    }
    nav#breadcrumb span.current {
      text-decoration: none;
      cursor: default;
      font-weight: bold;
    }
    /* Nuevos filtros admin */
    #admin-filters {
      margin: 15px 0 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    #admin-filters input {
      width: auto;
      max-width: 150px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Breadcrumb -->
  <nav id="breadcrumb"></nav>

  <div id="login-form">
    <h2>ü¶Å Registro de Entrada</h2>
    <input type="text" id="username" placeholder="Usuario" />
    <input type="password" id="password" placeholder="Contrase√±a" />
    <select id="role-select">
      <option value="Usuario">Docente</option>
      <option value="admin">Administrador</option>
    </select>
    <button id="login-button">üîì Iniciar sesi√≥n</button>
    <button id="register-button">üìù Registrarse</button>
    <button id="voice-login">üé§ Iniciar con voz</button>
    <button id="voice-register">üé§ Registrar con voz</button>
  </div>

  <div class="container" style="display:none;">
    <h2 id="welcome-title">Bienvenido</h2>
    <div class="video-container"><video id="video" autoplay></video></div>
    <button id="capture">‚úÖ Registrar Asistencia</button>
    <p id="loader">Registrando asistencia...</p>
    <button id="logout-button">‚èèÔ∏è Cerrar sesi√≥n</button>

    <h3>üìä Asistencia registrada</h3>
    <table id="attendance-table">
      <thead><tr><th>Usuario</th><th>Fecha</th><th>Hora</th></tr></thead>
      <tbody></tbody>
    </table>

    <div id="admin-panel" class="admin-container">
      <h3>üõ† Panel de Administrador</h3>
      <div id="admin-filters">
        <input type="text" id="filter-user" placeholder="Filtrar por usuario" />
        <input type="date" id="filter-date" />
        <button id="clear-filters">Limpiar filtros</button>
      </div>
      <button id="download-excel">üì• Descargar Excel</button>
      <table id="admin-attendance">
        <thead><tr><th>Usuario</th><th>Rol</th><th>Fecha</th><th>Hora</th><th>Acci√≥n</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="message-popup"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
  import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBQFdu36zRwL8OpoX6883pOuDyqcakfurY",
    authDomain: "asistencia-docentes-9de71.firebaseapp.com",
    databaseURL: "https://asistencia-docentes-9de71-default-rtdb.firebaseio.com",
    projectId: "asistencia-docentes-9de71",
    storageBucket: "asistencia-docentes-9de71.appspot.com",
    messagingSenderId: "535964294750",
    appId: "1:535964294750:web:1325e29f01a1e7be41f2be",
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Referencias DOM
  const loginForm = document.getElementById("login-form");
  const container = document.querySelector(".container");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const roleSelect = document.getElementById("role-select");
  const loginBtn = document.getElementById("login-button");
  const registerBtn = document.getElementById("register-button");
  const voiceLoginBtn = document.getElementById("voice-login");
  const voiceRegisterBtn = document.getElementById("voice-register");
  const logoutBtn = document.getElementById("logout-button");
  const captureBtn = document.getElementById("capture");
  const video = document.getElementById("video");
  const attendanceTableBody = document.querySelector("#attendance-table tbody");
  const adminPanel = document.getElementById("admin-panel");
  const adminAttendanceTableBody = document.querySelector("#admin-attendance tbody");
  const downloadExcelBtn = document.getElementById("download-excel");
  const filterUserInput = document.getElementById("filter-user");
  const filterDateInput = document.getElementById("filter-date");
  const clearFiltersBtn = document.getElementById("clear-filters");
  const breadcrumb = document.getElementById("breadcrumb");
  const messagePopup = document.getElementById("message-popup");
  const loader = document.getElementById("loader");
  const welcomeTitle = document.getElementById("welcome-title");

  // Estado
  let currentUser = null;
  let currentRole = null;
  let usersList = [];
  let attendanceRecords = [];
  let adminRecords = [];

  // Mostrar mensaje popup
  function showMessage(text, duration = 3000) {
    messagePopup.textContent = text;
    messagePopup.style.display = "block";
    setTimeout(() => {
      messagePopup.style.display = "none";
    }, duration);
  }

  // Breadcrumb navigation
  function updateBreadcrumb() {
    breadcrumb.innerHTML = "";
    if (!currentUser) {
      breadcrumb.innerHTML = `<span class="current">Login</span>`;
      return;
    }
    const homeSpan = document.createElement("span");
    homeSpan.textContent = "Inicio";
    homeSpan.style.cursor = "pointer";
    homeSpan.onclick = () => {
      showAttendanceView();
    };
    breadcrumb.appendChild(homeSpan);
    breadcrumb.innerHTML += " &gt; ";
    if (currentRole === "admin") {
      const adminSpan = document.createElement("span");
      adminSpan.textContent = "Panel Admin";
      adminSpan.classList.add("current");
      breadcrumb.appendChild(adminSpan);
    } else {
      const attendanceSpan = document.createElement("span");
      attendanceSpan.textContent = "Asistencia";
      attendanceSpan.classList.add("current");
      breadcrumb.appendChild(attendanceSpan);
    }
  }

  // Funci√≥n para iniciar c√°mara
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (error) {
      showMessage("No se pudo acceder a la c√°mara");
    }
  }

  // Guardar usuario y contrase√±a (en Realtime DB)
  function saveUser(username, password, role) {
    const usersRef = ref(db, "usuarios");
    push(usersRef, { username, password, role });
  }

  // Validar usuario y contrase√±a (login)
  function validateUser(username, password, role) {
    return new Promise((resolve) => {
      const usersRef = ref(db, "usuarios");
      onValue(usersRef, (snapshot) => {
        usersList = [];
        let valid = false;
        snapshot.forEach((child) => {
          const data = child.val();
          const key = child.key;
          usersList.push({ key, ...data });
          if (data.username === username && data.password === password && data.role === role) {
            valid = true;
            currentUser = data.username;
            currentRole = data.role;
            resolve(true);
          }
        });
        if (!valid) resolve(false);
      }, { onlyOnce: true });
    });
  }

  // Registrar asistencia
  function registerAttendance(user) {
    loader.style.display = "block";
    const now = new Date();
    const fecha = now.toLocaleDateString("es-ES");
    const hora = now.toLocaleTimeString("es-ES", { hour12: false });
    const attendanceRef = ref(db, "asistencia");
    push(attendanceRef, { username: user, fecha, hora }).then(() => {
      loader.style.display = "none";
      showMessage(`Asistencia registrada para ${user}`, 2500);
      loadAttendance(user);
      if (currentRole === "admin") {
        loadAdminAttendance();
      }
    });
  }

  // Cargar asistencia para usuario normal
  function loadAttendance(user) {
    const attendanceRef = ref(db, "asistencia");
    onValue(attendanceRef, (snapshot) => {
      attendanceTableBody.innerHTML = "";
      attendanceRecords = [];
      snapshot.forEach((child) => {
        const data = child.val();
        if (data.username === user) {
          attendanceRecords.push(data);
          const row = document.createElement("tr");
          row.innerHTML = `<td>${data.username}</td><td>${data.fecha}</td><td>${data.hora}</td>`;
          attendanceTableBody.appendChild(row);
        }
      });
    }, { onlyOnce: true });
  }

  // Cargar asistencia para admin
  function loadAdminAttendance() {
    const attendanceRef = ref(db, "asistencia");
    onValue(attendanceRef, (snapshot) => {
      adminAttendanceTableBody.innerHTML = "";
      adminRecords = [];
      snapshot.forEach((child) => {
        const data = child.val();
        adminRecords.push({ key: child.key, ...data });
      });
      renderAdminTable(adminRecords);
    }, { onlyOnce: true });
  }

  // Render tabla admin con filtros
  function renderAdminTable(records) {
    adminAttendanceTableBody.innerHTML = "";
    let filtered = records;

    const filterUser = filterUserInput.value.toLowerCase();
    const filterDate = filterDateInput.value;

    if (filterUser) {
      filtered = filtered.filter(r => r.username.toLowerCase().includes(filterUser));
    }
    if (filterDate) {
      filtered = filtered.filter(r => r.fecha === filterDate);
    }

    filtered.forEach(record => {
      const userData = usersList.find(u => u.username === record.username) || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${record.username}</td>
        <td>${userData.role || "-"}</td>
        <td>${record.fecha}</td>
        <td>${record.hora}</td>
        <td><button class="delete-btn" data-key="${record.key}">Eliminar</button></td>
      `;
      adminAttendanceTableBody.appendChild(tr);
    });

    // Eventos para eliminar
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.onclick = () => {
        const key = btn.getAttribute("data-key");
        remove(ref(db, `asistencia/${key}`))
          .then(() => {
            showMessage("Registro eliminado");
            loadAdminAttendance();
          });
      };
    });
  }

  // Exportar Excel
  function exportToExcel(records) {
    const wsData = [["Usuario", "Rol", "Fecha", "Hora"]];
    records.forEach(r => {
      const userRole = usersList.find(u => u.username === r.username)?.role || "-";
      wsData.push([r.username, userRole, r.fecha, r.hora]);
    });

    const worksheet = XLSX.utils.aoa_to_sheet(wsData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Asistencia");
    XLSX.writeFile(workbook, "registro_asistencia.xlsx");
  }

  // Eventos filtros admin
  filterUserInput.oninput = () => renderAdminTable(adminRecords);
  filterDateInput.onchange = () => renderAdminTable(adminRecords);
  clearFiltersBtn.onclick = () => {
    filterUserInput.value = "";
    filterDateInput.value = "";
    renderAdminTable(adminRecords);
  };

  // Mostrar vista de login
  function showLoginView() {
    loginForm.style.display = "block";
    container.style.display = "none";
    adminPanel.style.display = "none";
    updateBreadcrumb();
  }

  // Mostrar vista de asistencia usuario normal
  function showAttendanceView() {
    loginForm.style.display = "none";
    container.style.display = "block";
    adminPanel.style.display = "none";
    welcomeTitle.textContent = `Bienvenido, ${currentUser}`;
    updateBreadcrumb();
    loadAttendance(currentUser);
    startCamera();
  }

  // Mostrar vista admin
  function showAdminView() {
    loginForm.style.display = "none";
    container.style.display = "block";
    adminPanel.style.display = "block";
    welcomeTitle.textContent = `Administrador: ${currentUser}`;
    updateBreadcrumb();
    loadAdminAttendance();
    startCamera();
  }

  // Login
  loginBtn.onclick = async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const role = roleSelect.value;
    if (!username || !password) {
      showMessage("Completa usuario y contrase√±a");
      return;
    }
    const valid = await validateUser(username, password, role);
    if (valid) {
      showMessage("Login exitoso");
      if (role === "admin") showAdminView();
      else showAttendanceView();
    } else {
      showMessage("Usuario o contrase√±a incorrectos");
    }
  };

  // Registro
  registerBtn.onclick = () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const role = roleSelect.value;
    if (!username || !password) {
      showMessage("Completa usuario y contrase√±a");
      return;
    }
    // Verificar si usuario existe
    const exists = usersList.some(u => u.username === username);
    if (exists) {
      showMessage("Usuario ya registrado");
      return;
    }
    saveUser(username, password, role);
    showMessage("Usuario registrado. Ya puedes iniciar sesi√≥n.");
  };

  // Logout
  logoutBtn.onclick = () => {
    currentUser = null;
    currentRole = null;
    attendanceRecords = [];
    adminRecords = [];
    usernameInput.value = "";
    passwordInput.value = "";
    showLoginView();
    stopCamera();
  };

  // Registrar asistencia con bot√≥n
  captureBtn.onclick = () => {
    if (currentUser) {
      registerAttendance(currentUser);
    }
  };

  // C√°mara: parar c√°mara
  function stopCamera() {
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
  }

  // Reconocimiento de voz para login y registro
  async function voiceRecognitionProcess(isLogin) {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert("Tu navegador no soporta reconocimiento de voz");
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = "es-ES";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    showMessage(`Habla el usuario para ${isLogin ? "login" : "registro"}`, 4000);

    recognition.start();

    recognition.onresult = async (event) => {
      const spokenText = event.results[0][0].transcript.trim().toLowerCase();
      const words = spokenText.split(" ");
      if (words.length < 2) {
        showMessage("Debes decir usuario y contrase√±a separados por espacio");
        return;
      }
      const username = words[0];
      const password = words.slice(1).join(""); // junta el resto para password
      usernameInput.value = username;
      passwordInput.value = password;
      if (isLogin) {
        const role = roleSelect.value;
        const valid = await validateUser(username, password, role);
        if (valid) {
          showMessage("Login por voz exitoso");
          currentUser = username;
          currentRole = role;
          if (role === "admin") showAdminView();
          else showAttendanceView();
        } else {
          showMessage("Usuario o contrase√±a incorrectos");
        }
      } else {
        const exists = usersList.some(u => u.username === username);
        if (exists) {
          showMessage("Usuario ya registrado");
          return;
        }
        const role = roleSelect.value;
        saveUser(username, password, role);
        showMessage("Usuario registrado por voz. Ya puedes iniciar sesi√≥n.");
      }
    };

    recognition.onerror = (event) => {
      showMessage("Error en reconocimiento de voz: " + event.error);
    };
  }

  voiceLoginBtn.onclick = () => voiceRecognitionProcess(true);
  voiceRegisterBtn.onclick = () => voiceRecognitionProcess(false);

  // Descargar Excel admin
  downloadExcelBtn.onclick = () => {
    exportToExcel(adminRecords);
  };

  // Al cargar la p√°gina mostrar login
  showLoginView();

</script>
</body>
</html>

    <script type="module" src="script.js"></script>
  </body>
</html>
    <script type="module" src="script.js"></script>
  </body>
</html>